# Vibe Coding — Databricks UC Volume → Bronze · Silver · Gold - Medalion Architecture

## Executive Summary
This project delivers an AI-generated (vibe-coded) data pipeline that ingests heterogeneous CSV/JSON files from a Unity Catalog (UC) Volume into **Bronze** Delta tables, auto-cleans and deduplicates them into **Silver**, and produces **Gold** aggregates suitable for analytics (e.g., monthly sales and customer lifetime value). Code was produced through prompt-driven development, with curated prompts and iterations recorded in `PROMPTS.md`. The result is a governed, auditable, and reusable accelerator that turns file drops into consumable metrics with minimal engineer effort.

---

## 1) Use Case for Coding
**Goal**  
Automate onboarding of mixed CSV/JSON files in a UC Volume into governed Delta tables (Bronze→Silver→Gold) using AI-generated notebooks and jobs.

**Practical Use Cases**
- One-click onboarding of new partner file drops to Bronze.
- Rapid proof-of-concept ingestion for ad-hoc datasets.
- Schema-drift-tolerant landing zone with rescued-data preservation.
- Standardized Silver cleanup and deduplication for downstream modeling.
- Simple, ready-made Gold aggregates for reporting and dashboards.

**AI Toolkit Utilization**
- Notebook cells, job JSON, and bundle configuration generated by prompts (vibe coding).
- Iterative error resolution and feature adjustments performed by successive prompts.
- Prompt log with reasons and outcomes included in `PROMPTS.md`.

---

## 2) Solution & Benefits
**Key Requirements**
- Recursive discovery of CSV/JSON in a UC Volume.
- Dry-run planning, verification, and hard-stop preflight checks.
- Auto Loader **and** batch fallback paths.
- Ingest metadata and idempotency hash columns for dedupe.
- Partitioning, Change Data Feed (CDF), and post-run reporting.
- Simple Silver transformations and compact Gold aggregates.

**Implementation Approach**
- **Bronze:** Parameterized notebook groups files by folder/filename and ingests via Auto Loader (or batch), adds `_ingest_*` metadata, computes `_input_record_hash`, sets CDF and auto-optimization properties, and verifies each write.
- **Silver:** Generic loader enumerates Bronze tables, drops exact duplicates and all-null rows, attempts key-based deduplication, removes ingest metadata, timestamps loads, and overwrites the Silver tables.
- **Gold:** Minimal, business-ready artifacts (e.g., `gold_sales_monthly`, `vw_customer_ltv`), partitioned and optimized for common reporting and dashboards.

**Tangible Benefits**
- Significant reduction in time-to-ingest compared to hand-coded pipelines.
- Consistent governance (managed Delta + CDF) and traceability (history, properties).
- Lower defect rate through preflight validations and rescued data handling.

**Intangible Benefits**
- Standardized ingestion and modeling patterns across teams.
- Rapid iteration via prompts; faster onboarding and knowledge transfer.

**Acceptance Criteria**
- Preflight checks succeed (catalog/schema/volume access validated).
- Dry-run emits a plan and sample readability without writes.
- Load writes managed Delta tables with CDF and partitioning as configured.
- Post-run summary reports per-table status, row counts, and any errors.
- Silver and Gold objects are queryable and documented (history, comments).

---

## 3) Innovativeness
**Functional Novelty**
- Dual-path ingestion (Auto Loader + batch) under a single verification contract.
- Idempotent hashing (`_input_record_hash`) to prevent duplicate writes.
- Per-table overrides for read options, partitioning, and schema pinning.
- Machine-readable verification summaries to drive dashboards and alerts.

**Technology Highlights**
- Unity Catalog governance; Delta properties (CDF, autoOptimize, column mapping).
- AvailableNow micro-batch for first load; partitioning for efficient queries.

**Process Improvements**
- Replaces bespoke per-source jobs with a reusable accelerator template.
- Prompt log enables reproducibility and audit of AI-generated code changes.

**UX Enhancements & Advantages**
- Parameter widgets; dry-run planning; concise, structured logs.
- Simple Gold outputs that eliminate complex joins for common analytics.

**Unique Value Proposition**
- Governed, extensible ingest-to-metrics pipeline generated largely by prompts, reducing engineering lead time while improving consistency.

---

## 4) User Experience
**Usability**
- Parameter widgets configure catalog/schemas/volume and mode (dry-run/load).
- Dry-run previews schemas and options before any write occurs.
- Post-run status table summarizes outcomes; lightweight dashboard visuals.

**Accessibility**
- Analyst-friendly overrides allow delimiter/quote/multiline tweaks without code edits.
- Clear messages on privilege or path errors.

**Interaction Effectiveness & Efficiency**
- Two-step workflow: plan (dry-run) → execute (load).
- Verification and history enable quick triage and rollback.

---

## 5) Business Opportunity / Market Potential
**Opportunities**
- “Bronze Ingest Accelerator” for organizations adopting Databricks UC.
- Packaged component for consulting/system integrator engagements.
- Internal platform asset to standardize ingestion across domains.

**Customer Segments**
- Data platform teams, data engineering squads, and analytics enablement groups in regulated and data-heavy industries.

**Commercial Viability & Positioning**
- Reduces onboarding time and engineering cost per source.
- Differentiates through governance, verification, and prompt-driven extensibility.

**Growth & Expansion**
- Automated DLT Expectations for Silver quality checks.
- Policy-as-code for PII handling and column-level protections.
- Additional Gold templates (cohorting, RFM, promo lift, churn signals).

---

## 6) Ease of Implementation
**Readiness**
- Works on a UC-enabled cluster with `USE CATALOG`/`USE SCHEMA` privileges.
- No external infrastructure requirements; managed Delta tables.

**Practicality & Risk**
- Hard-stop preflight prevents misconfigured runs.
- Rescued data column and per-table overrides mitigate messy file issues.

**Complexity**
- Single Bronze notebook, one Silver loader, and a small Gold notebook.
- Optional bundle and job JSON for repeatable deployments.

**Technical Feasibility**
- Built using widely adopted Databricks/Delta features and SQL/PySpark patterns.

---

## 7) Scalable / Reusable
**Scalability**
- Auto Loader handles large file volumes; ingest-date partitioning supports pruning.
- AvailableNow for catch-up; micro-batches or schedules for ongoing loads.

**Reusability**
- Parameterized notebooks; retarget to a new volume/catalog by changing widgets only.
- Prompts and overrides enable rapid adaptation without code rewrites.

**Configurability**
- Table-level read options, partitioning, and schema pinning via overrides.
- Optional switch between Auto Loader and batch modes.

**Performance Evolution**
- OPTIMIZE + ZORDER strategies on high-traffic tables with minimal changes.

---

## 8) Financial Feasibility
**Costs**
- Uses existing Databricks entitlements (compute + storage).
- Initial “first load” compute; lighter daily incrementals thereafter.
- Storage growth proportional to input data plus checkpoints.

**Revenue / Savings**
- Engineer hours saved per source through prompt-driven generation and reusable templates.
- Lower failure/incident costs due to validations and verified writes.

**Cost–Benefit & ROI**
- Reduced build time vs manual pipelines; faster time-to-value for stakeholders.
- Break-even achieved quickly when onboarding multiple sources.

**Risk Assessment**
- Limited vendor risk (native features); operational risk mitigated via preflight/verification.

---

## Architecture Overview
**Bronze (Ingest)**
- Discovers files recursively in a UC Volume.
- Detects CSV/JSON; groups into tables by folder or filename.
- Ingests with Auto Loader (preferred) or batch fallback.
- Adds `_ingest_ts`, `_ingest_file_path`, `_ingest_file_name`, `_source_format`, `_input_record_hash`.
- Writes managed Delta with CDF; partitioned by `p_ingest_date`.
- Verification: table visibility, properties, partition, row counts, sample read.

**Silver (Load)**
- Enumerates Bronze tables; drops exact duplicates/all-null rows.
- Adds `_silver_loaded_at` timestamp.
- Optional dedup based on a detected key (`*id`/`*key`) and null filtering.
- Removes ingest metadata columns for a clean analytical schema.
- Overwrites managed Silver tables with schema evolution.

**Gold (Serve)**
- Minimal artifacts for immediate analytics:
  - `gold_sales_monthly`: `yyyymm × channel × category × subcategory` with revenue, units, orders, margin, AOV.
  - `vw_customer_ltv`: customer-level first/last purchase, orders, revenue, margin, avg inter-order days, and geography.
- Partitioned and optimized for common filters; concise metric definitions and comments.

---

## Deliverables & Evidence
- **Prompt Log:** `PROMPTS.md` (master + key iterations with reasons and outcomes).
- **Notebooks:**  
  - `notebooks/bronze_ingest` (UC Volume → Bronze).  
  - `notebooks/silver_load` (Bronze → Silver).  
  - `notebooks/gold_build` (Silver → Gold).
- **Jobs & Deployment:** `jobs/bronze_daily.json`, `bundles/bundle.yml`.
- **SQL/Optimization:** `sql/weekly_optimize.sql`.
- **Dashboards:** Lakeview/SQL visuals referencing Gold tables.
- **Runbook:** `RUNBOOK.md` (pre-reqs, execution steps, troubleshooting).
- **Architecture:** `ARCHITECTURE.md` (diagram and flows).
- **Business & Financials:** `BUSINESS.md`, `FINANCIALS.md`.

---

## Risk & Mitigation
- **Dirty or inconsistent files** → rescued data column, per-table read option overrides, quarantine patterns if needed.
- **Permissions or UC configuration issues** → hard-stop preflight with explicit guidance.
- **Name collisions or excessive groups** → sanitized names, deterministic suffixing, and group caps.
- **Compute cost spikes** → availableNow for initial catch-up, scheduled micro-batches for steady-state, periodic OPTIMIZE.

---

## Gold Metric Definitions (excerpt)
- **Revenue:** `SUM(SalesAmount)` aggregated to table grain.  
- **Units:** `SUM(OrderQuantity)`.  
- **Orders:** `COUNT(DISTINCT SalesOrderNumber)`.  
- **Gross Margin:** `SUM(SalesAmount - TotalProductCost)`.  
- **Average Order Value (AOV):** `Revenue / NULLIF(Orders, 0)`.

---

## Acceptance Tests (snapshot)
1. **Preflight:** `USE CATALOG`/`USE SCHEMA` succeed; volume path listable; non-zero discoverable CSV/JSON files.  
2. **Dry-Run:** Sample rows readable; plan shows groups, formats, and options; no writes occur.  
3. **Load:** Managed Delta tables created; CDF enabled; partition column present; non-zero row counts; 3-row sanity read passes.  
4. **Silver:** Duplicates removed; metadata columns dropped; `_silver_loaded_at` present; tables queryable.  
5. **Gold:** `gold_sales_monthly` and `vw_customer_ltv` present; `DESCRIBE HISTORY` shows latest version; preview queries return rows.  
6. **Reporting:** Post-run summary table returned; dashboard tiles populated from Gold.

---
